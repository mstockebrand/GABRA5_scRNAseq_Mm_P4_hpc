#  DOUBLET REMOVAL
##  Doublet detection and removal with DoubletFinder
use QC high quality data as input for DoubletFinder (https://doi.org/10.1016/j.cels.2019.03.003), https://github.com/chris-mcginnis-ucsf/DoubletFinder

### libraries
    # Libryries already activated before
        #library(dplyr)
        #library(Seurat)
        #library(patchwork)
        #library(ggplot2)
        #library(limma)
        #library(ggrepel)

        # libraries for QC
            #library(ggExtra)
            #library(cowplot)
            #library(Matrix)

    # libraries for doublet removal
      library(DoubletFinder)
      library(glmGamPoi) 

###  Pre-process Seurat object for doublet detection
    ##  split into single samples
        Scn2a.P4.list <- SplitObject(Scn2a.P4, split.by = "sample_no")

####  normalize data with SCTransform
SCTransform using fast glmGamPoi method and regressing confounders was not possible with lapply on elements from list
it worked with above methods in a for loop

        for (i in c(1:length(Scn2a.P4.list))){
                  Scn2a.P4.list[[i]] <- SCTransform(Scn2a.P4.list[[i]],
                                                     method = "glmGamPoi",
                                                     #verbose = FALSE,
                                                     vars.to.regress = c("nCount_RNA", "percent.mt"))
          }

####  linear dimensionality reduction: PCA
        Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = RunPCA)

####  non-linear dimensionality reduction with UMAP
        Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = RunUMAP, dims = 1:50)

####  clustering
        ##  Find Neighbors
            Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = FindNeighbors, dims = 1:50)
            
        ##  Find Clusters
            Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = FindClusters, resolution = 0.3)
            
        ##  visualize clustering
            lapply(X = Scn2.P4.list, FUN = DimPlot)

        ##  or plot everything together
            p1 <- DimPlot(Scn2a.P4.list[[1]]) & ggtitle("1")
            p2 <- DimPlot(Scn2a.P4.list[[2]]) & ggtitle("2")
            p3 <- DimPlot(Scn2a.P4.list[[3]]) & ggtitle("3")
            p4 <- DimPlot(Scn2a.P4.list[[4]]) & ggtitle("4")
            p5 <- DimPlot(Scn2a.P4.list[[5]]) & ggtitle("5")
            p6 <- DimPlot(Scn2a.P4.list[[6]]) & ggtitle("6")
            p7 <- DimPlot(Scn2a.P4.list[[7]]) & ggtitle("7")
            p8 <- DimPlot(Scn2a.P4.list[[8]]) & ggtitle("8")
            p9 <- DimPlot(Scn2a.P4.list[[9]]) & ggtitle("9")
            p10 <- DimPlot(Scn2a.P4.list[[10]]) & ggtitle("10")                
                
            p1 + 
              p2 + 
              p3 + 
              p4 +
              p5 +
              p6 +
              p7 +
              p8 +
              p9 +
              p10 +
              plot_layout(ncol=4) & NoLegend()

<p align="center">
<img src="https://github.com/mstockebrand/GABRA5_scRNAseq_Mm_P4_hpc/blob/main/Analysis Workflow/Figures/Doublet_Removal_Figs/Doublet_Removal_1_clustering.png" width="801" height="534"/>
</p>


###  doublet detection with DoubletFinder
pANN - proportion of artificial k neares neighbors

pN - defines number of generated artificial doublets, default 25%

pK - defines the PC neighborhood size for computing pANN, should be individually adjusted

nExp - pANN threshold f final doublet/singlet predictions  

####  split list
    X1 <- Scn2a.P4.list[[1]]
    X2 <- Scn2a.P4.list[[2]]
    X3 <- Scn2a.P4.list[[3]]
    X4 <- Scn2a.P4.list[[4]]
    X5 <- Scn2a.P4.list[[5]]
    X6 <- Scn2a.P4.list[[6]]
    X7 <- Scn2a.P4.list[[7]]
    X8 <- Scn2a.P4.list[[8]]
    X9 <- Scn2a.P4.list[[9]]
    X10 <- Scn2a.P4.list[[10]]
          
####  pK Identification (without ground-truth)
    sweep.res.list_1 <- paramSweep(X1, PCs = 1:15, sct = TRUE)
    sweep.res.list_2 <- paramSweep(X2, PCs = 1:15, sct = TRUE)
    sweep.res.list_3 <- paramSweep(X3, PCs = 1:15, sct = TRUE)
    sweep.res.list_4 <- paramSweep(X4, PCs = 1:15, sct = TRUE)
    sweep.res.list_5 <- paramSweep(X5, PCs = 1:15, sct = TRUE)
    sweep.res.list_6 <- paramSweep(X6, PCs = 1:15, sct = TRUE)
    sweep.res.list_7 <- paramSweep(X7, PCs = 1:15, sct = TRUE)
    sweep.res.list_8 <- paramSweep(X8, PCs = 1:15, sct = TRUE)
    sweep.res.list_9 <- paramSweep(X9, PCs = 1:15, sct = TRUE)
    sweep.res.list_10 <- paramSweep(X10, PCs = 1:15, sct = TRUE)
        
    sweep.stats_1 <- summarizeSweep(sweep.res.list_1, GT = FALSE)
    sweep.stats_2 <- summarizeSweep(sweep.res.list_2, GT = FALSE)
    sweep.stats_3 <- summarizeSweep(sweep.res.list_3, GT = FALSE)
    sweep.stats_4 <- summarizeSweep(sweep.res.list_4, GT = FALSE)
    sweep.stats_5 <- summarizeSweep(sweep.res.list_5, GT = FALSE)
    sweep.stats_6 <- summarizeSweep(sweep.res.list_6, GT = FALSE)
    sweep.stats_7 <- summarizeSweep(sweep.res.list_7, GT = FALSE)
    sweep.stats_8 <- summarizeSweep(sweep.res.list_8, GT = FALSE)
    sweep.stats_9 <- summarizeSweep(sweep.res.list_9, GT = FALSE)
    sweep.stats_10 <- summarizeSweep(sweep.res.list_10, GT = FALSE)
        
    bcmvn_1 <- find.pK(sweep.stats_1)
    bcmvn_2 <- find.pK(sweep.stats_2)
    bcmvn_3 <- find.pK(sweep.stats_3)
    bcmvn_4 <- find.pK(sweep.stats_4)
    bcmvn_5 <- find.pK(sweep.stats_5)
    bcmvn_6 <- find.pK(sweep.stats_6)
    bcmvn_7 <- find.pK(sweep.stats_7)
    bcmvn_8 <- find.pK(sweep.stats_8)
    bcmvn_9 <- find.pK(sweep.stats_9)
    bcmvn_10 <- find.pK(sweep.stats_10)
        
    bestpK_1 = as.numeric(as.character(bcmvn_1$pK[which.max(bcmvn_1$BCmetric)]))
    bestpK_2 = as.numeric(as.character(bcmvn_2$pK[which.max(bcmvn_2$BCmetric)]))
    bestpK_3 = as.numeric(as.character(bcmvn_3$pK[which.max(bcmvn_3$BCmetric)]))
    bestpK_4 = as.numeric(as.character(bcmvn_4$pK[which.max(bcmvn_4$BCmetric)]))
    bestpK_5 = as.numeric(as.character(bcmvn_5$pK[which.max(bcmvn_5$BCmetric)]))
    bestpK_6 = as.numeric(as.character(bcmvn_6$pK[which.max(bcmvn_6$BCmetric)]))
    bestpK_7 = as.numeric(as.character(bcmvn_7$pK[which.max(bcmvn_7$BCmetric)]))
    bestpK_8 = as.numeric(as.character(bcmvn_8$pK[which.max(bcmvn_8$BCmetric)]))
    bestpK_9 = as.numeric(as.character(bcmvn_9$pK[which.max(bcmvn_9$BCmetric)]))
    bestpK_10 = as.numeric(as.character(bcmvn_10$pK[which.max(bcmvn_10$BCmetric)]))

####  estimate homotypic doublet proportion
    homotypic.prop_1 <- modelHomotypic(X1@meta.data$seurat_clusters)
    homotypic.prop_2 <- modelHomotypic(X2@meta.data$seurat_clusters)
    homotypic.prop_3 <- modelHomotypic(X3@meta.data$seurat_clusters)
    homotypic.prop_4 <- modelHomotypic(X4@meta.data$seurat_clusters)
    homotypic.prop_5 <- modelHomotypic(X5@meta.data$seurat_clusters)
    homotypic.prop_6 <- modelHomotypic(X6@meta.data$seurat_clusters)
    homotypic.prop_7 <- modelHomotypic(X7@meta.data$seurat_clusters)
    homotypic.prop_8 <- modelHomotypic(X8@meta.data$seurat_clusters)
    homotypic.prop_9 <- modelHomotypic(X9@meta.data$seurat_clusters)
    homotypic.prop_10 <- modelHomotypic(X10@meta.data$seurat_clusters)

####  expected doublets
rate acc. to 
https://kb.10xgenomics.com/hc/en-us/articles/360001378811-What-is-the-maximum-number-of-cells-that-can-be-profiled

=> rate increases by 0.8% of cells per 1000 cells

=> nExp_poi_1 = round(0.008*(nrow(X@meta.data)/1000))*nrow(X@meta.data)

=> nExp_poi_1 = round(0.008/1000*nrow(X@meta.data)^2)

=> nExp_poi_1 = round(8E-6*nrow(X@meta.data)^2)

    nExp_poi_1 <- round(8E-6*nrow(X1@meta.data)^2)
    nExp_poi_2 <- round(8E-6*nrow(X2@meta.data)^2)
    nExp_poi_3 <- round(8E-6*nrow(X3@meta.data)^2)
    nExp_poi_4 <- round(8E-6*nrow(X4@meta.data)^2)
    nExp_poi_5 <- round(8E-6*nrow(X5@meta.data)^2)
    nExp_poi_6 <- round(8E-6*nrow(X6@meta.data)^2)
    nExp_poi_7 <- round(8E-6*nrow(X7@meta.data)^2)
    nExp_poi_8 <- round(8E-6*nrow(X8@meta.data)^2)
    nExp_poi_9 <- round(8E-6*nrow(X9@meta.data)^2)
    nExp_poi_10 <- round(8E-6*nrow(X10@meta.data)^2)

####  adjusted expected doublet rate (corrected for homotypic doublets)
    nExp_poi.adj_1 <- round(nExp_poi_1*(1-homotypic.prop_1))
    nExp_poi.adj_2 <- round(nExp_poi_2*(1-homotypic.prop_2))
    nExp_poi.adj_3 <- round(nExp_poi_3*(1-homotypic.prop_3))
    nExp_poi.adj_4 <- round(nExp_poi_4*(1-homotypic.prop_4))
    nExp_poi.adj_5 <- round(nExp_poi_5*(1-homotypic.prop_5))
    nExp_poi.adj_6 <- round(nExp_poi_6*(1-homotypic.prop_6))
    nExp_poi.adj_7 <- round(nExp_poi_7*(1-homotypic.prop_7))
    nExp_poi.adj_8 <- round(nExp_poi_8*(1-homotypic.prop_8))
    nExp_poi.adj_9 <- round(nExp_poi_9*(1-homotypic.prop_8))
    nExp_poi.adj_10 <- round(nExp_poi_10*(1-homotypic.prop_8))

####  Run DoubletFinder
with sample-specific classification stringencies

    Scn2a.P4_1 <- doubletFinder(X1, PCs = 1:15, pN = 0.25, pK = bestpK_1, nExp = nExp_poi.adj_1, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_2 <- doubletFinder(X2, PCs = 1:15, pN = 0.25, pK = bestpK_2, nExp = nExp_poi.adj_2, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_3 <- doubletFinder(X3, PCs = 1:15, pN = 0.25, pK = bestpK_3, nExp = nExp_poi.adj_3, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_4 <- doubletFinder(X4, PCs = 1:15, pN = 0.25, pK = bestpK_4, nExp = nExp_poi.adj_4, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_5 <- doubletFinder(X5, PCs = 1:15, pN = 0.25, pK = bestpK_5, nExp = nExp_poi.adj_5, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_6 <- doubletFinder(X6, PCs = 1:15, pN = 0.25, pK = bestpK_6, nExp = nExp_poi.adj_6, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_7 <- doubletFinder(X7, PCs = 1:15, pN = 0.25, pK = bestpK_7, nExp = nExp_poi.adj_7, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_8 <- doubletFinder(X8, PCs = 1:15, pN = 0.25, pK = bestpK_8, nExp = nExp_poi.adj_8, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_9 <- doubletFinder(X9, PCs = 1:15, pN = 0.25, pK = bestpK_9, nExp = nExp_poi.adj_9, reuse.pANN = FALSE, sct = TRUE)
    Scn2a.P4_10 <- doubletFinder(X10, PCs = 1:15, pN = 0.25, pK = bestpK_10, nExp = nExp_poi.adj_10, reuse.pANN = FALSE, sct = TRUE)

    ## seuratObjects may be saved here
       # saveRDS(Scn2a.P4_1, file = paste(path, "Scn2a_P4_DoubletFindeR1.rds", sep = "")
       # saveRDS(Scn2a.P4_2, file = paste(path, "Scn2a_P4_DoubletFindeR2.rds", sep = "")
    

