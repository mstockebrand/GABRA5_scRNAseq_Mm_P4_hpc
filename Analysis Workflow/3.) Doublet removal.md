#  Doublet Removal
##  Doublet detection and removal with DoubletFinder
use QC high quality data as input for DoubletFinder (https://doi.org/10.1016/j.cels.2019.03.003)

###  Pre-process Seurat object for doublet detection
    ##  split into single samples
        Scn2a.P4.list <- SplitObject(Scn2a.P4, split.by = "sample_no")

    ##  normalize data with SCTransform
        for (i in c(1:length(Scn2a.P4.list))){
                  Scn2a.P4.list[[i]] <- SCTransform(Scn2a.P4.list[[i]],
                                                     method = "glmGamPoi",
                                                     #verbose = FALSE,
                                                     vars.to.regress = c("nCount_RNA", "percent.mt"))
          }

    ##  linear dimensionality reduction: PCA
        Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = RunPCA)

    ##  non-linear dimensionality reduction with UMAP
        Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = RunUMAP, dims = 1:50)

    ##  clustering
        ##  Find Neighbors
            Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = FindNeighbors, dims = 1:50)
            
        ##  Find Clusters
            Scn2a.P4.list <- lapply(X = Scn2a.P4.list, FUN = FindClusters, resolution = 0.3)
            
        ##  visualize clustering
            lapply(X = Scn2.P4.list, FUN = DimPlot)

            p1 <- DimPlot(Scn2a.P4.list[[1]]) & ggtitle("1")
            p2 <- DimPlot(Scn2a.P4.list[[2]]) & ggtitle("2")
            p3 <- DimPlot(Scn2a.P4.list[[3]]) & ggtitle("3")
            p4 <- DimPlot(Scn2a.P4.list[[4]]) & ggtitle("4")
            p5 <- DimPlot(Scn2a.P4.list[[5]]) & ggtitle("5")
            p6 <- DimPlot(Scn2a.P4.list[[6]]) & ggtitle("6")
            p7 <- DimPlot(Scn2a.P4.list[[7]]) & ggtitle("7")
            p8 <- DimPlot(Scn2a.P4.list[[8]]) & ggtitle("8")
            p9 <- DimPlot(Scn2a.P4.list[[9]]) & ggtitle("9")
            p10 <- DimPlot(Scn2a.P4.list[[10]]) & ggtitle("10")                
                
            p1 + 
              p2 + 
              p3 + 
              p4 +
              p5 +
              p6 +
              p7 +
              p8 +
              p9 +
              p10 +
              plot_layout(ncol=4) & NoLegend()

###  doublet detection with DoubletFinder

          
